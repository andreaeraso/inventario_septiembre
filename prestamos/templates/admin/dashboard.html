{% extends 'base.html' %}

{% block content %}
<style>
/* ===== BASE ===== */
body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background:#f6f8f7;
}

/* ===== PANEL ===== */
.panel-wrapper {
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(6px);
    padding: 2.6rem 2.2rem;
    border-radius: 20px;
    color: #333;
    box-shadow: 0 12px 40px rgba(0,0,0,.1);
    animation: fadeUp .45s ease both;
}

/* ===== HEADER ===== */
.panel-header {
    border-bottom: 3px solid #0c7c3c;
    padding-bottom: 1.1rem;
    margin-bottom: 2.3rem;
    text-align: center;
}

.panel-header h3 {
    color: #0c7c3c;
    font-weight: 800;
    font-size: 2rem;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
}

/* ===== CARD ===== */
.prestamos-card {
    border-radius: 18px;
    border:none;
    overflow:hidden;
    box-shadow:0 10px 32px rgba(0,0,0,.12);
    animation: fadeUp .45s ease both;
}

.prestamos-card .card-header {
    background:#0c7c3c;
    color:#fff;
    font-weight:700;
    font-size:1.1rem;
    padding:1rem 1.6rem;
    display:flex;
    align-items:center;
    gap:10px;
}

/* ===== TABLE ===== */
.table th,
.table td {
    vertical-align: middle !important;
    text-align: center;
    font-size:.95rem;
}

.table-hover tbody tr {
    transition:.25s ease;
}

.table-hover tbody tr:hover {
    background:#f3fff7;
}

/* ===== BADGES ===== */
.badge-success {
    background:#0c7c3c;
    color:#fff;
    padding:.45rem .75rem;
    border-radius:10px;
    font-size:.85rem;
    font-weight:600;
}

.badge-warning {
    background:#ffc107;
    color:#222;
    padding:.45rem .75rem;
    border-radius:10px;
    font-size:.85rem;
    font-weight:600;
}

/* ===== BOTONES ===== */
.btn-sm {
    border-radius:8px;
    font-size:.85rem;
    padding:.35rem .65rem;
    transition:.25s ease;
}

.btn-sm:hover {
    transform: translateY(-1px);
    box-shadow:0 4px 10px rgba(0,0,0,.15);
}

.btn-outline-success {
    border-radius:8px;
}

/* ===== INLINE FORM ===== */
form.inline-form {
    display:inline;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 992px) {

    .table thead {
        display:none;
    }

    .table,
    .table tbody,
    .table tr,
    .table td {
        display:block;
        width:100%;
    }

    .table tr {
        margin-bottom:1.2rem;
        border:1px solid #e0e0e0;
        border-radius:16px;
        box-shadow:0 4px 14px rgba(0,0,0,.08);
        padding:.9rem;
        background:#fff;
    }

    .table td {
        text-align:left;
        padding:.6rem .8rem;
        border:none;
        position:relative;
    }

    .table td::before {
        content: attr(data-label);
        font-weight:600;
        color:#0c7c3c;
        display:block;
        margin-bottom:.25rem;
        font-size:.9rem;
    }

    .panel-wrapper {
        padding:1.3rem;
    }

    .panel-header h3 {
        font-size:1.55rem;
    }

    .prestamos-card .card-header {
        font-size:1rem;
        justify-content:center;
    }
}

@media (max-width: 400px) {
    .btn-sm {
        font-size:.8rem;
        padding:.3rem .55rem;
    }
}

/* ===== ANIMACIÓN ===== */
@keyframes fadeUp {
    from {
        opacity:0;
        transform:translateY(12px);
    }
    to {
        opacity:1;
        transform:none;
    }
}
</style>


<div class="container-fluid mt-4 px-2">
    <div class="panel-wrapper mx-auto">
        <!-- Encabezado -->
        <div class="panel-header">
            <h3><i class="fas fa-cogs"></i> Panel de Administración</h3>
        </div>

        <!-- Lista de Préstamos Recientes -->
        <div class="row">
            <div class="col-12">
                <div class="card prestamos-card">
                    <div class="card-header">
                        <i class="fas fa-clipboard-list"></i> Préstamos Recientes
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table table-bordered table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Recurso</th>
                                    <th>ID Recurso</th>
                                    <th>Usuario</th>
                                    <th>Fecha Aprobación</th>
                                    <th>Fecha Devolución</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prestamo in prestamos_recientes %}
                                <tr>
                                    <td data-label="Recurso">{{ prestamo.recurso.nombre }}</td>
                                    <td data-label="ID Recurso">{{ prestamo.recurso.id }}</td>
                                    <td data-label="Usuario">{{ prestamo.usuario.get_full_name }}</td>
                                    <td data-label="Fecha Aprobación">{{ prestamo.fecha_prestamo|date:"d/m/Y H:i" }}</td>
                                    <td data-label="Fecha Devolución">{{ prestamo.fecha_devolucion|date:"d/m/Y" }}</td>
                                    <td data-label="Estado">
                                        {% if prestamo.devuelto %}
                                            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Devuelto</span>
                                        {% else %}
                                            <span class="badge badge-warning"><i class="fas fa-hourglass-half"></i> Pendiente</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="Acciones">
                                        {% if not prestamo.devuelto %}
                                            <!-- Botón devolver -->
                                            <form action="{% url 'marcar_devuelto' prestamo.id %}" method="post" class="inline-form devolver-form">
                                                {% csrf_token %}
                                                <button type="button" class="btn btn-success btn-sm btn-devolver">
                                                    <i class="fas fa-check"></i> Devolver
                                                </button>
                                            </form>

                                            <!-- Botón extender -->
                                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#extenderModal{{ prestamo.id }}">
                                                <i class="fas fa-clock"></i> Extender
                                            </button>

                                            <!-- Modal -->
                                            <div class="modal fade" id="extenderModal{{ prestamo.id }}" tabindex="-1" aria-labelledby="extenderModalLabel{{ prestamo.id }}" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered">
                                                    <div class="modal-content">
                                                        <form action="{% url 'extender_prestamo' prestamo.id %}" method="post">
                                                            {% csrf_token %}
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="extenderModalLabel{{ prestamo.id }}"><i class="fas fa-clock"></i> Extender Préstamo</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <label for="nueva_fecha_{{ prestamo.id }}" class="form-label">Nueva fecha de devolución</label>
                                                                <input 
                                                                    type="date" 
                                                                    name="nueva_fecha" 
                                                                    id="nueva_fecha_{{ prestamo.id }}" 
                                                                    class="form-control" 
                                                                    required 
                                                                    min="{{ prestamo.fecha_devolucion|date:'Y-m-d' }}">
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                                <button type="submit" class="btn btn-success">Aceptar</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}

                                        <!-- Botón contrato (siempre visible) -->
                                        {% if prestamo.contrato_prestamo %}
                                            <a href="{{ prestamo.contrato_prestamo.url }}" class="btn btn-outline-success btn-sm" download>
                                                <i class="fas fa-download"></i> Contrato
                                            </a>
                                        {% else %}
                                            <span class="text-muted">Contrato no disponible</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">No hay préstamos recientes</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const devolverButtons = document.querySelectorAll('.btn-devolver');

    devolverButtons.forEach(button => {
        button.addEventListener('click', function() {
            const form = this.closest('.devolver-form');

            Swal.fire({
                title: '¿Estás seguro?',
                text: '¿Deseas marcar este recurso como devuelto?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#0c7c3c',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();  // ✅ Envía el formulario si confirma
                }
            });
        });
    });
});
</script>
{% endblock %}
